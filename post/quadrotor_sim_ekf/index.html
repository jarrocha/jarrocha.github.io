<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Innercoder.dev">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://jarrocha.github.io/img/backgrounds/tech18.jpg">
    <meta property="twitter:image" content="https://jarrocha.github.io/img/backgrounds/tech18.jpg" />
    

    
    <meta name="title" content="Extended Kalman Filter for Quadrotor Simulator" />
    <meta property="og:title" content="Extended Kalman Filter for Quadrotor Simulator" />
    <meta property="twitter:title" content="Extended Kalman Filter for Quadrotor Simulator" />
    

    
    <meta name="description" content="Design of a C&#43;&#43; based EKF estimator for a quadrotor simulator ">
    <meta property="og:description" content="Design of a C&#43;&#43; based EKF estimator for a quadrotor simulator " />
    <meta property="twitter:description" content="Design of a C&#43;&#43; based EKF estimator for a quadrotor simulator " />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="Linux, C, C&#43;&#43;, macOS, mbedOS">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Extended Kalman Filter for Quadrotor Simulator-Innercoder.dev</title>

    <link rel="canonical" href="/post/quadrotor_sim_ekf/">

    <link rel="stylesheet" href="/css/iDisqus.min.css"/>
	
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">
    
    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    
    

    
    
    <script src="/js/jquery.min.js"></script>
    
    
    <script src="/js/bootstrap.min.js"></script>
    
    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>



<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Innercoder.dev</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                        
                    
                    
		    
                        <li><a href="/top/upcoming/">UPCOMING</a></li>
                    
                        <li><a href="/top/courses/">COURSES</a></li>
                    
                        <li><a href="/top/about/">ABOUT</a></li>
                    

                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/backgrounds/tech6.jpg')
    }
</style>
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/quadrotor" title="Quadrotor">
                            Quadrotor
                        </a>
                        
                        <a class="tag" href="/tags/kalman-filter" title="Kalman Filter">
                            Kalman Filter
                        </a>
                        
                        <a class="tag" href="/tags/control-theory" title="Control Theory">
                            Control Theory
                        </a>
                        
                        <a class="tag" href="/tags/dynamic-systems" title="Dynamic Systems">
                            Dynamic Systems
                        </a>
                        
                    </div>
                    <h1>Extended Kalman Filter for Quadrotor Simulator</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by 
                        
                            Jaime Arrocha
                         
                        on 
                        Wednesday, August 25, 2021
                        
                        
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                post-container">

                
                <header>
                    <h2>TOC</h2>
                </header>
                <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#intro"><strong>Intro</strong></a></li>
        <li><a href="#implemented-estimator"><strong>Implemented Estimator</strong></a></li>
        <li><a href="#conclusion"><strong>Conclusion</strong></a></li>
      </ul>
    </li>
  </ul>
</nav>
                
                <h2 id="intro"><strong>Intro</strong></h2>
<hr>
<p>This project is the result for the training course for the <a href="https://www.udacity.com/course/flying-car-nanodegree--nd787">Flying Car Nanodegree.</a></p>
<p>The project consists on building an estimator based on the Extended Kalman filter. The lessons
started by giving us an introduction with the Bayes and Kalman filter, and then procedded to the
Extended and Unscented Kalman filter.</p>
<p>The steps in this project have us building an estimator step by step and at the end to test our
previous controller with non-ideal settings for the IMUs and Estimator.</p>
<h2 id="implemented-estimator"><strong>Implemented Estimator</strong></h2>
<hr>
<!-- raw HTML omitted -->
<hr>
<h3 id="step-1-sensor-noise"><strong>Step 1. Sensor Noise</strong></h3>
<hr>
<p>This step consisted on obtaining readings from both the GPS and Accelerometers and then calculating
the standard deviation. I obtained this data from the logs and exported it to Excel to obtain the
results.</p>
<p>Results:</p>
<pre><code>GPS   std: 0.7127969
Accel std: 0.4874375
</code></pre><pre><code>Simulation #3 (../config/06_SensorNoise.txt)
PASS: ABS(Quad.GPS.X-Quad.Pos.X) was less than MeasuredStdDev_GPSPosXY for 71% of the time
PASS: ABS(Quad.IMU.AX-0.000000) was less than MeasuredStdDev_AccelXY for 67% of the time
</code></pre><p>
  <img src="/img/quad_sim_ekf/scenario6.png" alt="Quad Image">

</p>
<!-- raw HTML omitted -->
<hr>
<h3 id="step-2-attitude-estimation"><strong>Step 2. Attitude Estimation</strong></h3>
<hr>
<p>This step consisted on implemeting <strong>UpdateFromIMU()</strong> to improve the estimated Attitude Error.</p>
<pre><code>Simulation #26 (../config/07_AttitudeEstimation.txt)
PASS: ABS(Quad.Est.E.MaxEuler) was less than 0.100000 for at least 3.000000 seconds
</code></pre><p>
  <img src="/img/quad_sim_ekf/scenario7.gif" alt="Quad Image">

</p>
<!-- raw HTML omitted -->
<hr>
<h3 id="step-3-prediction-step"><strong>Step 3. Prediction Step</strong></h3>
<hr>
<p>In this step we start working with the actual filter. The Update is already done for us so, our
work consists on construction the matrices to update the state/mean of your system through prediction,
update the Kalman gain and the new covariance.</p>
<p>As you can see on the animation below, there&rsquo;s good tracking of the X and Y position and velocity.</p>
<p>
  <img src="/img/quad_sim_ekf/scenario8.gif" alt="Quad Image">

</p>
<p>The second part of this step consisted on creating the rest of the Predict algorithm which was
constructing the Jacobian matrix for the State Transition matrix and tuning <code>QPosXYStd</code> and the
<code>QVelXYStd</code> values in the estimator configuration file. The goal was to create a close envelop for the
position and velocity errors for several drones as show in the picture below.</p>
<p>
  <img src="/img/quad_sim_ekf/scenario9.gif" alt="Quad Image">

</p>
<!-- raw HTML omitted -->
<hr>
<h3 id="step-4-magnetometer-update"><strong>Step 4. Magnetometer Update</strong></h3>
<hr>
<p>This step consisted on developing the function that updates the measurement matrix for the
magnetometer, which will then triger the <strong>Update()</strong> call to correct to the actual mean and
covariance.</p>
<pre><code>Simulation #3 (../config/10_MagUpdate.txt)
PASS: ABS(Quad.Est.E.Yaw) was less than 0.120000 for at least 10.000000 seconds
PASS: ABS(Quad.Est.E.Yaw-0.000000) was less than Quad.Est.S.Yaw for 69% of the time
</code></pre><p>
  <img src="/img/quad_sim_ekf/scenario10.gif" alt="Quad Image">

</p>
<!-- raw HTML omitted -->
<hr>
<h3 id="step-5-closed-loop--gps-update"><strong>Step 5. Closed Loop + GPS Update</strong></h3>
<hr>
<p>This was the last step to finalize our estimator. It involved in finalizing the GPS update
function <code>UpdateFromGPS()</code> and then removing the ideal IMU and Estimator from the configuration
file and then tuning our estimator. The process was to progressively add more complexity after
finalizing the estimator code.</p>
<p><strong>First step:</strong> Test estimator algorithm with ideal IMU and ideal Estimator</p>
<p>
  <img src="/img/quad_sim_ekf/scen11_idealIMU_idealEST.gif" alt="Quad Image">

</p>
<p><strong>Second step:</strong> Test estimator algorithm with ideal IMU and Non-Ideal Estimator</p>
<p>
  <img src="/img/quad_sim_ekf/scen11_idealIMU_CustEST.gif" alt="Quad Image">

</p>
<p><strong>Third step:</strong> Test estimator algorithm with Non-Ideal IMU and Non-Ideal Estimator</p>
<p>
  <img src="/img/quad_sim_ekf/scen11_CustIMY_CustEST.gif" alt="Quad Image">

</p>
<p><strong>Fourth step:</strong> After adjusting parameters in <code>QuadEstimatorEKF.txt</code></p>
<pre><code>Simulation #3 (../config/11_GPSUpdate.txt)
PASS: ABS(Quad.Est.E.Pos) was less than 1.000000 for at least 20.000000 seconds
</code></pre><p>
  <img src="/img/quad_sim_ekf/scen11_correction.gif" alt="Quad Image">

</p>
<!-- raw HTML omitted -->
<hr>
<h3 id="step-6-adding-your-controller"><strong>Step 6. Adding Your Controller</strong></h3>
<hr>
<p>This was one the trickiest part of the project. The drone crashed so many times that I thought
that something was wrong in the dynamics. But after almost 1 hour of tinkering I found the correct
parameters through trial and error, following the recommended steps of <strong>de-tuning</strong> and testing
with ideal sensors first.</p>
<p>As you can see in the pic below (sorry for the low detail), the test passed.</p>
<pre><code>Simulation #21 (../config/11_GPSUpdate.txt)
PASS: ABS(Quad.Est.E.Pos) was less than 1.000000 for at least 20.000000 seconds
</code></pre><p>
  <img src="/img/quad_sim_ekf/scenario11_step6.gif" alt="Quad Image">

</p>
<h2 id="conclusion"><strong>Conclusion</strong></h2>
<hr>
<p>This was a necessary project to put in practice and cement the knowledge obtained from the lectures.
I know feel more confident on these topics given that I took some time off the lectures to get more
acquainted with random process, least-squares, and kalman filter theory. I all paid off. I&rsquo;m know
looking forward to apply all this things with the crazyflie drone I just bought. Thank you for creating
this course.</p>


                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/quadrotor_sim_pid/" data-toggle="tooltip" data-placement="top" title="Quadrotor C&#43;&#43; PID Controller for Simulator">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/spi_driver_test/" data-toggle="tooltip" data-placement="top" title="STM32 SPI Driver Testing with Logic Analyzer">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>

                
<div id="disqus-comment"></div>



            </div>
            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        
                        
                        <a href="/tags/bash" title="bash">
                            bash
                        </a>
                        
                        
                        
                        <a href="/tags/c" title="c">
                            c
                        </a>
                        
                        
                        
                        <a href="/tags/control-theory" title="control-theory">
                            control-theory
                        </a>
                        
                        
                        
                        <a href="/tags/development" title="development">
                            development
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/dynamic-systems" title="dynamic-systems">
                            dynamic-systems
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/kvm" title="kvm">
                            kvm
                        </a>
                        
                        
                        
                        <a href="/tags/linux" title="linux">
                            linux
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/opencv" title="opencv">
                            opencv
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/python" title="python">
                            python
                        </a>
                        
                        
                        
                        <a href="/tags/qemu" title="qemu">
                            qemu
                        </a>
                        
                        
                        
                        <a href="/tags/quadrotor" title="quadrotor">
                            quadrotor
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/tcp/ip" title="tcp/ip">
                            tcp/ip
                        </a>
                        
                        
                        
                        <a href="/tags/x86-assembly" title="x86-assembly">
                            x86-assembly
                        </a>
                        
                        
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                    
                    <li>
                        <a href="mailto:jarrocha@linux.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    

                    

		    
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/jarrocha">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    <li>
                        <a target="_blank" href="https://gitlab.com/jarrocha27">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-gitlab fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
            
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/jaime-arrocha-337b0488/">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    <li>
                        <a target="_blank" href="https://stackoverflow.com/users/3848072/jarr">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
            
                    
                    
                    
            
            
            
                </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Innercoder.dev 2022
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






</body>
</html>
