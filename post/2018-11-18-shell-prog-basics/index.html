<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Innercoder.dev">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://jarrocha.github.io/img/backgrounds/iot.jpg">
    <meta property="twitter:image" content="https://jarrocha.github.io/img/backgrounds/iot.jpg" />
    

    
    <meta name="title" content="Programming a Linux Shell Terminal" />
    <meta property="og:title" content="Programming a Linux Shell Terminal" />
    <meta property="twitter:title" content="Programming a Linux Shell Terminal" />
    

    
    <meta name="description" content="A basic terminal command shell for Linux">
    <meta property="og:description" content="A basic terminal command shell for Linux" />
    <meta property="twitter:description" content="A basic terminal command shell for Linux" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="Linux, C, C&#43;&#43;, macOS, mbedOS">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Programming a Linux Shell Terminal-Innercoder.dev</title>

    <link rel="canonical" href="/post/2018-11-18-shell-prog-basics/">

    <link rel="stylesheet" href="/css/iDisqus.min.css"/>
	
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">
    
    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    
    

    
    
    <script src="/js/jquery.min.js"></script>
    
    
    <script src="/js/bootstrap.min.js"></script>
    
    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>



<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Innercoder.dev</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                        
                    
                    
		    
                        <li><a href="/top/upcoming/">UPCOMING</a></li>
                    
                        <li><a href="/top/courses/">COURSES</a></li>
                    
                        <li><a href="/top/about/">ABOUT</a></li>
                    

                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/post-bg-unix-linux.jpg')
    }
</style>
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/development" title="Development">
                            Development
                        </a>
                        
                        <a class="tag" href="/tags/linux" title="Linux">
                            Linux
                        </a>
                        
                    </div>
                    <h1>Programming a Linux Shell Terminal</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by 
                        
                            Jaime Arrocha
                         
                        on 
                        Tuesday, January 12, 2016
                        
                        
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                post-container">

                
                <header>
                    <h2>TOC</h2>
                </header>
                <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#introduction">Introduction</a></li>
      </ul>
    </li>
  </ul>
</nav>
                
                <h2 id="introduction">Introduction</h2>
<p>A shell is an interactive program that in its core forks for new processes
and wait for their termination. In other words, we present a prompt, the
user enters the commands, we parse the input , and execute it. Good error
and signal handling is needed, as well as the return values of the different
system calls that we will use. The man pages come real handy for this since
we have a very good reference just a terminal screen away. This program is
considered a good start to learn the basic of system calls and signal processing.
This post serves as a quick analysis of the code in the <a href="https://github.com/jarrocha/bschell">github repository</a>.</p>
<p><strong>Note:</strong> the complete code of an older version is fully
posted in the end. Check my github repo for an updated version. Use the link above.</p>
<p>This shell features some basic error and signal handling, use of system calls
(fork, waitpid, execve), background processes, and directory change. And more
than implementing a lot of features from the beginning, it is going to focus on a
smaller set of features but well implemented.</p>
<p>Below is the basic structure for each new process. This structure can also be
used later on when a job list is implemented. This is still in the TODO list and
can serve as the second part for the development of this project.</p>
<p>The last two members are for storing the input buffer and an array of pointers
to it, respectively. Since the same buffer variable is used to capture the input,
each process structure will hold its own input.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> proc_st {
        <span style="color:#66d9ef">int</span> bg;
        <span style="color:#66d9ef">int</span> exec;
        <span style="color:#66d9ef">int</span> commc;
        <span style="color:#66d9ef">int</span> fd_out;
        <span style="color:#66d9ef">int</span> fd_in;
        pid_t pid;
        <span style="color:#66d9ef">char</span> pbuff[MAX_LEN];
        <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>commv[];
};
</code></pre></div><p>Here are the function prototypes of the program so far. The used for error
feedback, signal handling, and command identification respectively.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">/* function prototypes */</span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">error_msg</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sig_handler</span>(<span style="color:#66d9ef">int</span>);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">comm_identi</span>(<span style="color:#66d9ef">struct</span> proc_st <span style="color:#f92672">*</span>, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>);
</code></pre></div><p>The following are for the initialization of the signal handlers. The signal function
call’s first argument is used to identify the signal and the second argument is set the
action to perform when received. SIG_IGN is used for ignoring the signal. For the signal
SIGCHLD, a handler function is given. Why the special case for SIGCHLD? Since we are
allowing background processes and the signal is by default ignored, the shell needs to
know about the finished background processes so as to not leave zombie processes behind.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">/* initialize signal handlers */</span>
signal(SIGINT, SIG_IGN);
signal(SIGQUIT, SIG_IGN);
signal(SIGCHLD, sig_handler);
</code></pre></div><ul>
<li>Line 4: obtains input from the user.</li>
<li>Line 10: sets an internal flag to let the program know to send the command arguments for execution.</li>
<li>Line 11: send the obtained string input for parsing and identification.</li>
<li>Line 13-20: if command is executable, then proceed to fork and wait if it is not a background job.</li>
<li>Line 23-28: check if the command is set to be performed in the background.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">printf(<span style="color:#e6db74">&#34;[SHELL]&gt; &#34;</span>);
<span style="color:#66d9ef">for</span> (;;) {

  <span style="color:#66d9ef">while</span> (fgets(buff, MAX_LEN, stdin) <span style="color:#f92672">!=</span> NULL) {

      proc <span style="color:#f92672">=</span> malloc(<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> proc_st) <span style="color:#f92672">+</span> MAX_ARGS);

      <span style="color:#75715e">/*initialize to zero */</span>
      memset(proc, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> proc_st));
      proc<span style="color:#f92672">-&gt;</span>exec <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
      comm_identi(proc, buff);

      <span style="color:#66d9ef">if</span> (proc<span style="color:#f92672">-&gt;</span>exec <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
          <span style="color:#66d9ef">if</span> ((pid <span style="color:#f92672">=</span> fork()) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> ) {
              printf(<span style="color:#e6db74">&#34;fork error&#34;</span>);
          } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (pid <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) { <span style="color:#75715e">/* child */</span>
              <span style="color:#66d9ef">if</span> (execvp(<span style="color:#f92672">*</span>(proc<span style="color:#f92672">-&gt;</span>commv), proc<span style="color:#f92672">-&gt;</span>commv) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> )
                  error_msg(<span style="color:#e6db74">&#34;could not execute&#34;</span>);
              free(proc);
          }

          <span style="color:#75715e">/* parent */</span>
          <span style="color:#66d9ef">if</span> (proc<span style="color:#f92672">-&gt;</span>bg <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
              <span style="color:#66d9ef">if</span> ((pid <span style="color:#f92672">=</span> waitpid(pid, <span style="color:#f92672">&amp;</span>status, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
                  error_msg(<span style="color:#e6db74">&#34;waitpid error&#34;</span>);
          } <span style="color:#66d9ef">else</span>
              printf(<span style="color:#e6db74">&#34;PID %d %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pid, proc<span style="color:#f92672">-&gt;</span>pbuff);
      }
      free(proc);
      printf(<span style="color:#e6db74">&#34;[SHELL]&gt; &#34;</span>);
  }
}
exit(<span style="color:#ae81ff">0</span>);
</code></pre></div><p>The other important function peforms parsing of the input string buffer and
command identification for built-in commands. Parsing is done with the strtok()
function. There are many ways to implement the parsing though. The function
strcmp() is used for a simple identification of built-in functions.</p>
<ul>
<li>Line 5-14: performs parsing with the strtok() function.</li>
<li>Line 16: necessary limiting for command pointer array.</li>
<li>Line 19-36: this section checks for built-in commands.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">comm_identi</span>(<span style="color:#66d9ef">struct</span> proc_st <span style="color:#f92672">*</span>proc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buffer)
{
        <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>tmp;

        <span style="color:#75715e">/* replace newline with null */</span>
        <span style="color:#66d9ef">if</span> (buffer[strlen(buffer) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\n&#39;</span>)
                buffer[strlen(buffer) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        strncpy(proc<span style="color:#f92672">-&gt;</span>pbuff,buffer,MAX_LEN);

        tmp <span style="color:#f92672">=</span> strtok(buffer, <span style="color:#e6db74">&#34; &#34;</span>);
        <span style="color:#66d9ef">while</span> (tmp <span style="color:#f92672">!=</span> NULL) {
                proc<span style="color:#f92672">-&gt;</span>commv[(proc<span style="color:#f92672">-&gt;</span>commc)<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> tmp;
                tmp <span style="color:#f92672">=</span> strtok(NULL, <span style="color:#e6db74">&#34; &#34;</span>);
        }

        proc<span style="color:#f92672">-&gt;</span>commv[proc<span style="color:#f92672">-&gt;</span>commc] <span style="color:#f92672">=</span> NULL;

        <span style="color:#75715e">/* check for built-in functions */</span>
        <span style="color:#66d9ef">if</span> (proc<span style="color:#f92672">-&gt;</span>commc <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1</span>) {
                <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>strcmp(proc<span style="color:#f92672">-&gt;</span>commv[<span style="color:#ae81ff">0</span>], <span style="color:#e6db74">&#34;exit&#34;</span>)) {
                        free(proc);
                        exit(EXIT_SUCCESS);
                }

                <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>strcmp(proc<span style="color:#f92672">-&gt;</span>commv[<span style="color:#ae81ff">0</span>], <span style="color:#e6db74">&#34;cd&#34;</span>)) {
                        proc<span style="color:#f92672">-&gt;</span>exec <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
                        <span style="color:#66d9ef">if</span> (chdir(proc<span style="color:#f92672">-&gt;</span>commv[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
                                error_msg(<span style="color:#e6db74">&#34;chdir() error&#34;</span>);
                }

                <span style="color:#75715e">/* check if it is a background process */</span>
                <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>proc<span style="color:#f92672">-&gt;</span>commv[(proc<span style="color:#f92672">-&gt;</span>commc) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&amp;&#39;</span>) {
                        proc<span style="color:#f92672">-&gt;</span>bg <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
                        proc<span style="color:#f92672">-&gt;</span>commv[(proc<span style="color:#f92672">-&gt;</span>commc) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> NULL;
                }
        }

        <span style="color:#66d9ef">return</span>;
}
</code></pre></div><p>If interested, download the code and modify it to your liking. Fix any bugs or
improve on it. That’s the only way to learn. If you are unsure about any <!-- raw HTML omitted -->libc<!-- raw HTML omitted -->
funtion use the man pages. Though for beginners it might be a little puzzling
at first, they are straight to the point and very informative.
I also recommend Stevens <!-- raw HTML omitted -->Advanced Programming in the Unix Environment<!-- raw HTML omitted -->,
Kerrisk <!-- raw HTML omitted -->The Linux Programming Interface<!-- raw HTML omitted -->, and O&rsquo;Hallaron <!-- raw HTML omitted -->Computer Systems: A
Programmer’s Perspective<!-- raw HTML omitted -->.</p>
<p>Update for <a href="https://github.com/jarrocha/bscshell">Basic Shell v2</a>:</p>
<ul>
<li>better handling of signals. Removed unsafe function calls. But sigaction() is still needed for a even better handling.</li>
<li>implemented a jump table for built-in commands.</li>
<li>removed unneeded allocation and frees.</li>
</ul>


                

                <hr>
                <ul class="pager">
                    
                    
                    <li class="next">
                        <a href="/post/2018-11-18-performance-analysis-i/" data-toggle="tooltip" data-placement="top" title="Code Performance Analysis With Assembly &amp; C: Part 1">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>

                
<div id="disqus-comment"></div>



            </div>
            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        <a href="/tags/arm" title="arm">
                            arm
                        </a>
                        
                        
                        
                        <a href="/tags/bash" title="bash">
                            bash
                        </a>
                        
                        
                        
                        <a href="/tags/c" title="c">
                            c
                        </a>
                        
                        
                        
                        <a href="/tags/development" title="development">
                            development
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/dynamic-systems" title="dynamic-systems">
                            dynamic-systems
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/kvm" title="kvm">
                            kvm
                        </a>
                        
                        
                        
                        <a href="/tags/linux" title="linux">
                            linux
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/opencv" title="opencv">
                            opencv
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/python" title="python">
                            python
                        </a>
                        
                        
                        
                        <a href="/tags/qemu" title="qemu">
                            qemu
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/tcp/ip" title="tcp/ip">
                            tcp/ip
                        </a>
                        
                        
                        
                        <a href="/tags/x86-assembly" title="x86-assembly">
                            x86-assembly
                        </a>
                        
                        
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                    
                    <li>
                        <a href="mailto:jarrocha@linux.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    

                    

		    
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/jarrocha">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    <li>
                        <a target="_blank" href="https://gitlab.com/jarrocha27">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-gitlab fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
            
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/jaime-arrocha-337b0488/">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    <li>
                        <a target="_blank" href="https://stackoverflow.com/users/3848072/jarr">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
            
                    
                    
                    
            
            
            
                </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Innercoder.dev 2022
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






</body>
</html>
